<html>
	<head>
		<title>ElDewrito Server Browser 0.00000002 Pre-Release Alpha Special Collectors Edition</title>
		<meta http-equiv="refresh" content="5; url=http://example.com/">
	</head>
	<body>
		<button id="refresh">Refresh</button>
		<h4><span id="playerCount">00</span> players / <span id="serverCount">00</span> servers</h4>
		<table id="serverlist" style="width:100%">
			<tr>
				<td>Server Name (host player)</td>
				<td>Map</td>
				<td>Game Type</td>
				<td>Status</td>
				<td>Players</td>
			</tr>
		</table><br>
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
		<script type="text/javascript">
			let playerCount = 0;
			let serverCount = 0;
			let dewConnected = false;
			
			$.getScript( "dew://lib/dew.js" )
				.done(function() {
				dewConnected = true;
			});
			
			$(document).ready(function() {
				// addServer("127.0.0.1:11775", "Test server", "emoose", "Guardian", "guardian", "Team Slayer", "1", "16");
			});
			$("#refresh").click(function() {
				playerCount = 0;
				serverCount = 0;
				$("#serverlist").find("tr:gt(0)").remove();
				$.getJSON("http://master.zgaf.io/list", function(data) {
					if (data.result.code != 0) {
						alert("Error received from master: " + data.result.msg);
						return;
					}
					serverCount = data.result.servers.length;
					$('#serverCount')[0].innerHTML = serverCount;
					//console.log(data);
					for (var i = 0; i < serverCount; i++) {
						let serverIP = data.result.servers[i];
						queryServer(serverIP);
					}
				});
			});
			
			function queryServer(serverIP) {
				//console.log(serverIP);
				$.getJSON("http://" + serverIP, function(serverInfo) {
					let isPassworded = serverInfo.passworded !== undefined;
					playerCount += serverInfo.numPlayers;
					addServer(
						serverIP,
						isPassworded,
						serverInfo.name,
						serverInfo.hostPlayer,
						serverInfo.map,
						serverInfo.mapFile,
						serverInfo.variant,
						serverInfo.status,
						serverInfo.numPlayers,
						serverInfo.maxPlayers
					);
					$('#playerCount')[0].innerHTML = playerCount;
					//console.log(serverInfo);
				});
			}
			
			function promptPassword(serverIP) {
				var password = prompt("The server at " + serverIP + " is passworded, enter the password to join", "");
				if (password != null) {
					//window.open("dorito:" + serverIP + "/" + password);
					dew.command('connect ' + serverIP + ' ' + password);
				}
			}
			
			function addServer(ip, isPassworded, name, host, map, mapfile, gamemode, status, numplayers, maxplayers) {
				//let servName = "<td><a href=\"dorito:" + ip + "\">" + name + " (" + host + ")</a></td>";
				let servName = "<td><a onclick=\"dew.command(" + ip + ")\">" + name + " (" + host + ")</a></td>";
				if (isPassworded)
					servName = "<td><a href=\"#\" onclick=\"promptPassword('" + ip + "');\">[PASSWORDED] " + name + " (" + host + ")</a></td>";
				let servMap = "<td>" + map + " (" + mapfile + ")</td>";
				let servType = "<td>" + gamemode + "</td>";
				let servStatus = "<td>" + status + "</td>";
				let servPlayers = "<td>" + numplayers + "/" + maxplayers + "</td>";
				$('#serverlist tr:last').after("<tr>" + servName + servMap + servType + servStatus + servPlayers + "</tr>");
			} 
		</script>
	</body>
</html>
