<html>
<head>
    <title>ElDewrito Server Browser 0.00000002 Pre-Release Alpha Special Collectors Edition</title>
</head>
<body>
    <button id="refresh">Refresh</button>
    <h4 id="serverStats"> 
        <span id="serverCount">00 servers</span> / 
        <span id="playerCount">00 players</span>
    </h4>
    <table id="serverlist" style="width:100%">
        <tr>
            <td>Server Name (host player)</td>
            <td>Map</td> 
            <td>Game Type</td>
            <td>Status</td>
            <td>Players</td>
        </tr>
    </table><br>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script type="text/javascript">
        let serverCount = 0;
        let playerCount = 0;
        $(document).ready( function() {
                // addServer("127.0.0.1:11775", "Test server", "emoose", "Guardian", "guardian", "Team Slayer", "1", "16");
                //$("#refresh").click();
        });
        
        $("#refresh").click( function() {
            serverCount = 0;
            playerCount = 0;
            $("#serverlist").find("tr:gt(0)").remove();
            $.getJSON( "http://eldewrito.red-m.net/list", function( data ) {
                if(data.result.code != 0) {
                    alert("Error received from master: " + data.result.msg);
                    return;
                }
                //console.log(data);
                for(var i = 0; i < data.result.servers.length; i++) {
                    var serverIP = data.result.servers[i];
                    queryServer(serverIP);
                    
                    $('#serverCount').after("<span id=\"serverCount\">" + serverCount + " server</span>");
                    $('#playerCount').after("<span id=\"playerCount\">" + playerCount + " players</span>");
                }
            });
        });

        function queryServer(serverIP) {
            serverCount += 1;
            playerCount += serverInfo.numPlayers;
            //console.log(serverIP);
            $.getJSON("http://" + serverIP, function(serverInfo) {
                var isPassworded = serverInfo.passworded !== undefined;
                addServer(
                    serverIP, isPassworded, serverInfo.name, serverInfo.hostPlayer, 
                    serverInfo.map, serverInfo.mapFile, serverInfo.variant, 
                    serverInfo.status, serverInfo.numPlayers, serverInfo.maxPlayers
                );
                //console.log(serverInfo);
            });
        }

        function promptPassword(serverIP) {
            var password = prompt("The server at " + serverIP + " is passworded, enter the password to join", "");
            if(password != null) {
                window.open("dorito:" + serverIP + "/" + password);
            }
        }

        function addServer(ip, isPassworded, name, host, map, mapfile, gamemode, status, numplayers, maxplayers) {
            var servName = "<td><a href=\"dorito:" + ip + "\">" + name + " (" + host + ")</a></td>";
            if(isPassworded)
            servName = "<td><a href=\"#\" onclick=\"promptPassword('" + ip + "');\">[PASSWORDED] " + name + " (" + host + ")</a></td>";

            var servMap = "<td>" + map + " (" + mapfile + ")</td>";
            var servType = "<td>" + gamemode + "</td>";
            var servStatus = "<td>" + status + "</td>";
            var servPlayers = "<td>" + numplayers + "/" + maxplayers + "</td>";
        }
    </script>
</body>
</html>
